name: 'publish'

on: 
  workflow_dispatch:
  push:

# `tauri-action` can also upload app bundles to an existing GitHub release.
# This workflow uses different actions to create and publish the release.
# `tauri-action` will only build and upload the app bundles to the specified release.

jobs:
  create-release:
    permissions:
      contents: write
    runs-on: ubuntu-latest
    outputs:
      release_id: ${{ steps.create-release.outputs.result }}
      portable_file_name_win: ${{ env.PORTABLE_FILE_NAME_WIN }}
      portable_file_name_linux: ${{ env.PORTABLE_FILE_NAME_LINUX }}
      
    steps:
      - uses: actions/checkout@v4

      - name: setup node
        uses: actions/setup-node@v4
        with:
          node-version: lts/*

      - name: get version
        run: |
          export PACKAGE_VERSION=$(node -p "require('./package.json').version")
          echo "PACKAGE_VERSION=$(node -p "require('./package.json').version")" >> $GITHUB_ENV
          echo "PORTABLE_FILE_NAME_WIN=oplus_edl_toolkit-$PACKAGE_VERSION.x86_64_win_portable.zip" >> $GITHUB_ENV
          echo "PORTABLE_FILE_NAME_LINUX=oplus_edl_toolkit-$PACKAGE_VERSION.x86_64_linux_portable.zip" >> $GITHUB_ENV
          
      - name: create release
        id: create-release
        uses: actions/github-script@v6
        with:
          script: |
            const { data } = await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: `V${process.env.PACKAGE_VERSION}`,
              name: `OPlus EDL Toolkit V${process.env.PACKAGE_VERSION}`,
              body: 'Take a look at the assets to download and install this app.',
              draft: true,
              prerelease: false
            })
            return data.id

  build-tauri:
    needs: create-release
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'ubuntu-24.04' # for Tauri v1 you could replace this with ubuntu-20.04.
            args: ''
          - platform: 'windows-latest'
            args: ''

    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@v4

      - name: setup node
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
          
      - name: install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          # Those targets are only used on macos runners so it's in an `if` to slightly speed up windows and linux builds.
          targets: ${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || '' }}

      - name: install dependencies (ubuntu only)
        if: matrix.platform == 'ubuntu-24.04' # This must match the platform value defined above.
        run: |
          sudo apt-get update
          sudo apt-get install -y zip build-essential pkg-config libudev-dev libusb-1.0-0-dev curl wget file libxdo-dev libssl-dev libayatana-appindicator3-dev libwebkit2gtk-4.1-dev librsvg2-dev patchelf 

      - name: install frontend dependencies
        run: npm install # change this to npm, pnpm or bun depending on which one you use.

      - uses: tauri-apps/tauri-action@v0.6
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          releaseId: ${{ needs.create-release.outputs.release_id }}
          args: ${{ matrix.args }}

      - name: Compress oplus_edl_toolkit  (windows only)
        if: matrix.platform == 'windows-latest'
        run: |
          md D:\a\release\OPlus_EDL_Toolkit
          copy D:\a\OPlus_EDL_Toolkit\OPlus_EDL_Toolkit\src-tauri\target\release\oplus_edl_toolkit.exe D:\a\release\OPlus_EDL_Toolkit\
          xcopy D:\a\OPlus_EDL_Toolkit\OPlus_EDL_Toolkit\src-tauri\res D:\a\release\OPlus_EDL_Toolkit\res /E /I
          xcopy D:\a\OPlus_EDL_Toolkit\OPlus_EDL_Toolkit\src-tauri\img D:\a\release\OPlus_EDL_Toolkit\img /E /I
          xcopy D:\a\OPlus_EDL_Toolkit\OPlus_EDL_Toolkit\src-tauri\tools D:\a\release\OPlus_EDL_Toolkit\tools /E /I
          Compress-Archive -Path D:\a\release\OPlus_EDL_Toolkit -Destination oplus_edl_toolkit.zip

      - name: Compress oplus_edl_toolkit  (linux only)
        if: matrix.platform == 'ubuntu-24.04'
        run: |
          mkdir -p release/OPlus_EDL_Toolkit
          cp /home/runner/work/OPlus_EDL_Toolkit/OPlus_EDL_Toolkit/src-tauri/target/release/bundle/appimage/oplus_edl_toolkit_*.AppImage release/OPlus_EDL_Toolkit/
          cp -a /home/runner/work/OPlus_EDL_Toolkit/OPlus_EDL_Toolkit/src-tauri/res release/OPlus_EDL_Toolkit/
          cp -a /home/runner/work/OPlus_EDL_Toolkit/OPlus_EDL_Toolkit/src-tauri/img release/OPlus_EDL_Toolkit/
          cp -a /home/runner/work/OPlus_EDL_Toolkit/OPlus_EDL_Toolkit/src-tauri/tools release/OPlus_EDL_Toolkit/
          chmod a+x release/OPlus_EDL_Toolkit/tools/*
          chmod a+x release/OPlus_EDL_Toolkit/*.AppImage
          cd release
          zip -r oplus_edl_toolkit.zip OPlus_EDL_Toolkit/
          mv oplus_edl_toolkit.zip ..

      - name: Upload an Asset in GitHub Release (windows only)
        if: matrix.platform == 'windows-latest'
        uses: "actions/github-script@v6"
        env:
          release_id: ${{ needs.create-release.outputs.release_id }}
          file_name: ${{ needs.create-release.outputs.portable_file_name_win }}
        with:
          github-token: "${{ secrets.GITHUB_TOKEN }}"
          script: |
            const fs = require('fs').promises;
            await github.rest.repos.uploadReleaseAsset({
              name: process.env.file_name,
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: process.env.release_id,
              data: await fs.readFile('oplus_edl_toolkit.zip') 
            });

      - name: Upload an Asset in GitHub Release (linux only)
        if: matrix.platform == 'ubuntu-24.04'
        uses: "actions/github-script@v6"
        env:
          release_id: ${{ needs.create-release.outputs.release_id }}
          file_name: ${{ needs.create-release.outputs.portable_file_name_linux }}
        with:
          github-token: "${{ secrets.GITHUB_TOKEN }}"
          script: |
            const fs = require('fs').promises;
            await github.rest.repos.uploadReleaseAsset({
              name: process.env.file_name,
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: process.env.release_id,
              data: await fs.readFile('oplus_edl_toolkit.zip') 
            });
          
  publish-release:
    permissions:
      contents: write
    runs-on: ubuntu-latest
    needs: [create-release, build-tauri]

    steps:
      - name: publish release
        id: publish-release
        uses: actions/github-script@v6
        env:
          release_id: ${{ needs.create-release.outputs.release_id }}
        with:
          script: |
            github.rest.repos.updateRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: process.env.release_id,
              draft: false,
              prerelease: false
            })
